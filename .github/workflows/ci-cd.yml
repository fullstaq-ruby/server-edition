# WARNING: DO NOT EDIT THIS FILE!!!
#
# This file is autogenerated from .github/workflows/ci-cd.yml.erb
# by ./internal-scripts/generate-ci-cd-yaml.rb.
# Please edit the .erb file instead, then regenerate YAML
# by running that script.
#
# TIP: run this on your development machine to ensure generate-ci-cd-yaml.rb
# is run automatically as a Git pre-commit hook:
#
#   git config core.hooksPath .githooks

name: CI/CD

on:
  push:
    paths-ignore:
      - '*.md'
      - '.github/**/*.md'
  pull_request:
    paths-ignore:
      - '*.md'
      - '.github/**/*.md'

env:
  BINTRAY_ORG: fullstaq

jobs:
  check_workflow_uptodate:
    name: Check whether workflow is up-to-date
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'

      - name: Check
        run: ./internal-scripts/ci-cd/check-workflow-uptodate/check.sh
      - name: Show differences
        run: git diff --no-index --color .github/workflows/ci-cd.yml .github/workflows/ci-cd.yml.2
        if: '!cancelled() && failure()'


  check_version_numbers_need_bumping:
    name: Check whether any version numbers need to be changed
    needs: download_rbenv_source
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'
      - name: Fetch Rbenv source
        uses: actions/download-artifact@v1
        with:
          name: rbenv-src
          path: .

      - name: Extract Rbenv source
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/extract-rbenv-source.sh
      - name: Determine latest release tag
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh

      - name: Check whether the Rbenv version in config.yml is correct
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-rbenv-version.sh
        if: '!cancelled()'
      - name: Check whether the Rbenv package revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-rbenv-package-revision.sh
        if: '!cancelled()'

      - name: Check whether the fullstaq-ruby-common Debian package version or revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-common-deb-version-revision.sh
        if: '!cancelled()'
      - name: Check whether the fullstaq-ruby-common RPM package version or revision needs to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-common-rpm-version-revision.sh
        if: '!cancelled()'

      - name: Check whether any Ruby package revisions need to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-ruby-package-revisions.sh
        if: '!cancelled()'

      - name: Check whether any minor Ruby package revisions need to be changed
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/check-minor-ruby-package-revisions.sh
        if: '!cancelled()'


  ### Docker images ###

  build_docker_images:
    name: Build Docker images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        image: 
          - name: fullstaq/ruby-build-env-centos-7
            id: centos-7
            tag: '3'
          - name: fullstaq/ruby-build-env-centos-8
            id: centos-8
            tag: '1'
          - name: fullstaq/ruby-build-env-debian-10
            id: debian-10
            tag: '1'
          - name: fullstaq/ruby-build-env-debian-9
            id: debian-9
            tag: '2'
          - name: fullstaq/ruby-build-env-ubuntu-18.04
            id: ubuntu-18.04
            tag: '2'
          - name: fullstaq/ruby-build-env-utility
            id: utility
            tag: '3'
    steps:
      - uses: actions/checkout@v2

      - name: Determine whether image needs to be built
        id: prepare
        run: ./internal-scripts/ci-cd/build-docker-images/prepare.sh
        env:
          IMAGE_NAME: ${{ matrix.image.name }}
          IMAGE_TAG: ${{ matrix.image.tag }}
          IMAGE_ID: ${{ matrix.image.id }}
          CI_REF: ${{ github.ref }}
          CI_RUN_NUMBER: ${{ github.run_number }}

      - name: Login to Google Container Registry
        id: gcloud_login
        if: steps.prepare.outputs.needs-building == 'true'
        run: ./internal-scripts/ci-cd/build-docker-images/login-gcr.sh
        env:
          SERVICE_ACCOUNT_KEY_JSON: ${{ secrets.GCLOUD_KEY }}
      - name: Build
        if: steps.prepare.outputs.needs-building == 'true'
        run: ./internal-scripts/ci-cd/build-docker-images/build.sh
        env:
          IMAGE_NAME: ${{ steps.prepare.outputs.image-name }}
          IMAGE_TAG: ${{ steps.prepare.outputs.image-tag }}
          SOURCE_DIR: environments/${{ matrix.image.id }}
      - name: Publish
        if: steps.prepare.outputs.needs-building == 'true'
        run: ./internal-scripts/ci-cd/build-docker-images/publish.sh
        env:
          IMAGE_NAME: ${{ steps.prepare.outputs.image-name }}
          IMAGE_TAG: ${{ steps.prepare.outputs.image-tag }}

      - name: Create artifact
        run: ./internal-scripts/ci-cd/build-docker-images/create-artifact.sh
        env:
          IMAGE_NAME: ${{ steps.prepare.outputs.image-name }}
          IMAGE_TAG: ${{ steps.prepare.outputs.image-tag }}
      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: docker-image-info-${{ matrix.image.id }}
          path: output


  ### Sources ###

  download_ruby_sources:
    name: Download Ruby sources
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_version: 
          - 2.7.1
          - 2.6.6
          - 2.5.8
    steps:
      - name: Fetch cache
        id: fetch_cache
        uses: actions/cache@v1
        with:
          path: output
          key: v3-ruby-src-${{ matrix.ruby_version }}

      - uses: actions/checkout@v2
        if: steps.fetch_cache.outputs.cache-hit != 'true'
      - name: Download
        run: ./internal-scripts/ci-cd/download-ruby-sources/download.sh
        if: steps.fetch_cache.outputs.cache-hit != 'true'
        env:
          RUBY_VERSION: ${{ matrix.ruby_version }}

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_version }}
          path: output


  download_rbenv_source:
    name: Download Rbenv source
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'
      - name: Prepare
        id: prepare
        run: ./internal-scripts/ci-cd/download-rbenv-source/prepare.sh
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: output
          key: v2-rbenv-src-${{ steps.prepare.outputs.cache_key }}

      - name: Download
        run: ./internal-scripts/ci-cd/download-rbenv-source/download.sh
        env:
          RBENV_REPO_URL: ${{ steps.prepare.outputs.repo_url }}
          RBENV_REPO_REF: ${{ steps.prepare.outputs.ref }}

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: rbenv-src
          path: output


  ### Jemalloc ###

  build_jemalloc_binaries:
    name: Build Jemalloc binaries
    needs: build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        distribution: 
          - name: centos-7
            package_format: RPM
          - name: centos-8
            package_format: RPM
          - name: debian-10
            package_format: DEB
          - name: debian-9
            package_format: DEB
          - name: ubuntu-18.04
            package_format: DEB
    steps:
      - uses: actions/checkout@v2
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: jemalloc-bin-${{ matrix.distribution.name }}-3.6.0
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-${{ matrix.distribution.name }}
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Download source
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/download-source.sh
        env:
          JEMALLOC_VERSION: "3.6.0"

      - name: Build
        run: ./internal-scripts/ci-cd/build-jemalloc-binaries/build.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: ${{ matrix.distribution.name }}

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: jemalloc-bin-${{ matrix.distribution.name }}
          path: output


  ### fullstaq-ruby-common ###

  build_common_deb:
    name: Build common DEB
    needs: build_docker_images
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Build package
        run: ./internal-scripts/ci-cd/build-common-deb/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          PACKAGE_BASENAME: "fullstaq-ruby-common_1.0-0_all.deb"
          VERSION: "1.0"
          REVISION: "0"

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: common-deb
          path: output


  build_common_rpm:
    name: Build common RPM
    needs: build_docker_images
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Build package
        run: ./internal-scripts/ci-cd/build-common-rpm/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          PACKAGE_BASENAME: "fullstaq-ruby-common-1.0-0.noarch.rpm"
          VERSION: "1.0"
          REVISION: "0"

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: common-rpm
          path: output


  ### Rbenv ###

  build_rbenv_deb:
    name: Build Rbenv DEB
    needs:
      - download_rbenv_source
      - build_docker_images
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Fetch Rbenv source
        uses: actions/download-artifact@v1
        with:
          name: rbenv-src
          path: .

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Build package
        run: ./internal-scripts/ci-cd/build-rbenv-deb/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          PACKAGE_BASENAME: "fullstaq-rbenv_1.1.2-7-1_all.deb"
          REVISION: "1"

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: rbenv-deb
          path: output


  build_rbenv_rpm:
    name: Build Rbenv RPM
    needs:
      - download_rbenv_source
      - build_docker_images
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Fetch Rbenv source
        uses: actions/download-artifact@v1
        with:
          name: rbenv-src
          path: .

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Build package
        run: ./internal-scripts/ci-cd/build-rbenv-rpm/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          PACKAGE_BASENAME: "fullstaq-rbenv-1.1.2-7-1.noarch.rpm"
          REVISION: "1"

      - name: Archive artifact
        uses: actions/upload-artifact@v1
        with:
          name: rbenv-rpm
          path: output


  ### Ruby ###

  # The Github Actions matrix is limited to producing 256 jobs. Given the
  # combinatorial explosion, it's very easy to reach that limit, so we
  # preprocess distribution information using ERB templating instead.


  build_ruby_packages_centos_7:
    name: Build Ruby packages [centos-7]
    needs:
      - download_ruby_sources
      - build_jemalloc_binaries
      - build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2

      - name: Fetch Ruby source
        uses: actions/download-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_package_version.full_version }}
          path: .
      - name: Fetch Jemalloc binary
        uses: actions/download-artifact@v1
        with:
          name: jemalloc-bin-centos-7
          path: .
        if: matrix.variant.name == 'jemalloc'
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: ruby-bin-${{ matrix.ruby_package_version.id }}-centos-7-${{ matrix.variant.name }}
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-centos-7
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build binaries
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: "centos-7"
          VARIANT_NAME: ${{ matrix.variant.name }}
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}

      - name: Determine which Docker image to use for packaging
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build package
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          DISTRIBUTION_NAME: "centos-7"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}
          RUBY_PACKAGE_REVISION: ${{ matrix.ruby_package_version.package_revision }}

      - name: Archive package artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-pkg_${{ matrix.ruby_package_version.id }}_centos-7_${{ matrix.variant.name }}
          path: output


  build_ruby_packages_centos_8:
    name: Build Ruby packages [centos-8]
    needs:
      - download_ruby_sources
      - build_jemalloc_binaries
      - build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2

      - name: Fetch Ruby source
        uses: actions/download-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_package_version.full_version }}
          path: .
      - name: Fetch Jemalloc binary
        uses: actions/download-artifact@v1
        with:
          name: jemalloc-bin-centos-8
          path: .
        if: matrix.variant.name == 'jemalloc'
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: ruby-bin-${{ matrix.ruby_package_version.id }}-centos-8-${{ matrix.variant.name }}
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-centos-8
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build binaries
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: "centos-8"
          VARIANT_NAME: ${{ matrix.variant.name }}
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}

      - name: Determine which Docker image to use for packaging
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build package
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          DISTRIBUTION_NAME: "centos-8"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          PACKAGE_FORMAT: "RPM"
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}
          RUBY_PACKAGE_REVISION: ${{ matrix.ruby_package_version.package_revision }}

      - name: Archive package artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-pkg_${{ matrix.ruby_package_version.id }}_centos-8_${{ matrix.variant.name }}
          path: output


  build_ruby_packages_debian_10:
    name: Build Ruby packages [debian-10]
    needs:
      - download_ruby_sources
      - build_jemalloc_binaries
      - build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2

      - name: Fetch Ruby source
        uses: actions/download-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_package_version.full_version }}
          path: .
      - name: Fetch Jemalloc binary
        uses: actions/download-artifact@v1
        with:
          name: jemalloc-bin-debian-10
          path: .
        if: matrix.variant.name == 'jemalloc'
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: ruby-bin-${{ matrix.ruby_package_version.id }}-debian-10-${{ matrix.variant.name }}
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-debian-10
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build binaries
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: "debian-10"
          VARIANT_NAME: ${{ matrix.variant.name }}
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}

      - name: Determine which Docker image to use for packaging
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build package
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          DISTRIBUTION_NAME: "debian-10"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}
          RUBY_PACKAGE_REVISION: ${{ matrix.ruby_package_version.package_revision }}

      - name: Archive package artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-pkg_${{ matrix.ruby_package_version.id }}_debian-10_${{ matrix.variant.name }}
          path: output


  build_ruby_packages_debian_9:
    name: Build Ruby packages [debian-9]
    needs:
      - download_ruby_sources
      - build_jemalloc_binaries
      - build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2

      - name: Fetch Ruby source
        uses: actions/download-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_package_version.full_version }}
          path: .
      - name: Fetch Jemalloc binary
        uses: actions/download-artifact@v1
        with:
          name: jemalloc-bin-debian-9
          path: .
        if: matrix.variant.name == 'jemalloc'
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: ruby-bin-${{ matrix.ruby_package_version.id }}-debian-9-${{ matrix.variant.name }}
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-debian-9
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build binaries
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: "debian-9"
          VARIANT_NAME: ${{ matrix.variant.name }}
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}

      - name: Determine which Docker image to use for packaging
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build package
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          DISTRIBUTION_NAME: "debian-9"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}
          RUBY_PACKAGE_REVISION: ${{ matrix.ruby_package_version.package_revision }}

      - name: Archive package artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-pkg_${{ matrix.ruby_package_version.id }}_debian-9_${{ matrix.variant.name }}
          path: output


  build_ruby_packages_ubuntu_18_04:
    name: Build Ruby packages [ubuntu-18.04]
    needs:
      - download_ruby_sources
      - build_jemalloc_binaries
      - build_docker_images
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2

      - name: Fetch Ruby source
        uses: actions/download-artifact@v1
        with:
          name: ruby-src-${{ matrix.ruby_package_version.full_version }}
          path: .
      - name: Fetch Jemalloc binary
        uses: actions/download-artifact@v1
        with:
          name: jemalloc-bin-ubuntu-18.04
          path: .
        if: matrix.variant.name == 'jemalloc'
      - name: Fetch cache
        uses: actions/cache@v1
        with:
          path: cache
          key: ruby-bin-${{ matrix.ruby_package_version.id }}-ubuntu-18.04-${{ matrix.variant.name }}
      - name: Create cache dir
        run: mkdir -p cache

      - name: Determine which Docker image to use for building
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-ubuntu-18.04
          path: .
      - name: Load build image info
        id: load_build_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build binaries
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-binaries.sh
        env:
          BUILD_IMAGE_NAME: ${{ steps.load_build_image_info.outputs.image-name }}
          BUILD_IMAGE_TAG: ${{ steps.load_build_image_info.outputs.image-tag }}
          ENVIRONMENT_NAME: "ubuntu-18.04"
          VARIANT_NAME: ${{ matrix.variant.name }}
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}

      - name: Determine which Docker image to use for packaging
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh
      - name: Build package
        run: ./internal-scripts/ci-cd/build-ruby-packages/build-package.sh
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          DISTRIBUTION_NAME: "ubuntu-18.04"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          PACKAGE_FORMAT: "DEB"
          RUBY_PACKAGE_VERSION_ID: ${{ matrix.ruby_package_version.id }}
          RUBY_PACKAGE_REVISION: ${{ matrix.ruby_package_version.package_revision }}

      - name: Archive package artifact
        uses: actions/upload-artifact@v1
        with:
          name: ruby-pkg_${{ matrix.ruby_package_version.id }}_ubuntu-18.04_${{ matrix.variant.name }}
          path: output



  ### Create test APT/YUM repos ###

  create_test_apt_repo:
    name: Create test APT repo
    runs-on: ubuntu-18.04
    needs:

      - build_ruby_packages_debian_10

      - build_ruby_packages_debian_9

      - build_ruby_packages_ubuntu_18_04

    steps:
      - uses: actions/checkout@v2
      - name: Recreate repo
        run: ./internal-scripts/ci-cd/publish/recreate-apt-repo.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ github.run_number }}


  create_test_yum_repo:
    name: Create test YUM repo
    needs:

      - build_ruby_packages_centos_7

      - build_ruby_packages_centos_8

    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Recreate repo
        run: ./internal-scripts/ci-cd/publish/recreate-yum-repo.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ github.run_number }}


  ### Publish common and fullstaq-rbenv packages to test repos

  publish_common_and_rbenv_debs_test:
    name: Publish common and Rbenv DEBs to test repo
    needs:
      - build_docker_images
      - create_test_apt_repo
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Download artifact
        uses: actions/download-artifact@v1
        with:
          name: common-deb
          path: .
      - name: Download artifact
        uses: actions/download-artifact@v1
        with:
          name: rbenv-deb
          path: .

      - name: Determine which Docker image to use for publishing
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Upload to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh *.deb
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ github.run_number }}
          DRY_RUN: false
          IGNORE_EXISTING: false


  publish_common_and_rbenv_rpms_test:
    name: Publish common and Rbenv RPMs to test repo
    needs:
      - build_docker_images
      - create_test_yum_repo
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Download artifact
        uses: actions/download-artifact@v1
        with:
          name: common-rpm
          path: .
      - name: Download artifact
        uses: actions/download-artifact@v1
        with:
          name: rbenv-rpm
          path: .

      - name: Determine which Docker image to use for publishing
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Upload to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh *.rpm
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ github.run_number }}
          DRY_RUN: false
          IGNORE_EXISTING: false


  ### Publish Ruby packages to test repos

  publish_ruby_packages_test:
    name: Publish Ruby packages to test repo
    needs:
      - build_docker_images
      - create_test_apt_repo
      - create_test_yum_repo
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2



      - name: Fetch ruby-pkg_2.7_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: ruby-pkgs


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: ruby-pkgs


      - name: Determine which Docker image to use for publishing
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Upload DEBs to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh ruby-pkgs/*.deb
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ github.run_number }}
          DRY_RUN: false
          IGNORE_EXISTING: false
      - name: Upload RPMs to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh ruby-pkgs/*.rpm
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ github.run_number }}
          DRY_RUN: false
          IGNORE_EXISTING: false

  commit_published_packages_test:
    name: Commit packages published to test repo
    needs:
      - publish_common_and_rbenv_debs_test
      - publish_common_and_rbenv_rpms_test
      - publish_ruby_packages_test
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Commit files published to APT repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt-ci-${{ github.run_number }}

      - name: Commit files published to YUM repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum-ci-${{ github.run_number }}


  ### Test packages against test repos ###

  # The Github Actions matrix is limited to producing 256 jobs. Given the
  # combinatorial explosion, it's very easy to reach that limit, so we
  # preprocess distribution information using ERB templating instead.


  test_packages_against_test_centos_7:
    name: Test Ruby packages against test repos [centos-7]
    needs: commit_published_packages_test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ github.run_number }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ github.run_number }}


  test_packages_against_test_centos_8:
    name: Test Ruby packages against test repos [centos-8]
    needs: commit_published_packages_test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ github.run_number }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ github.run_number }}


  test_packages_against_test_debian_10:
    name: Test Ruby packages against test repos [debian-10]
    needs: commit_published_packages_test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ github.run_number }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ github.run_number }}


  test_packages_against_test_debian_9:
    name: Test Ruby packages against test repos [debian-9]
    needs: commit_published_packages_test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ github.run_number }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ github.run_number }}


  test_packages_against_test_ubuntu_18_04:
    name: Test Ruby packages against test repos [ubuntu-18.04]
    needs: commit_published_packages_test
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-apt-ci-${{ github.run_number }}
          YUM_REPO_URL: https://dl.bintray.com/fullstaq/fullstaq-ruby-yum-ci-${{ github.run_number }}


  ### Publish packages to production repo ###

  publish_packages_production:
    name: Publish packages to production repos
    needs:

      - test_packages_against_test_centos_7

      - test_packages_against_test_centos_8

      - test_packages_against_test_debian_10

      - test_packages_against_test_debian_9

      - test_packages_against_test_ubuntu_18_04

    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Download fullstaq-common DEB
        uses: actions/download-artifact@v1
        with:
          name: common-deb
          path: .
      - name: Download fullstaq-common RPM
        uses: actions/download-artifact@v1
        with:
          name: common-rpm
          path: .
      - name: Download Rbenv DEB
        uses: actions/download-artifact@v1
        with:
          name: rbenv-deb
          path: .
      - name: Download Rbenv RPM
        uses: actions/download-artifact@v1
        with:
          name: rbenv-rpm
          path: .



      - name: Fetch ruby-pkg_2.7_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.7_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.7_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.7_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.7_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7_ubuntu-18.04_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.6_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.6_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.6_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.6_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6_ubuntu-18.04_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.5_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.5_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.5_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.5_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5_ubuntu-18.04_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7.1_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7.1_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.7.1_ubuntu-18.04_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6.6_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6.6_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.6.6_ubuntu-18.04_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-7_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_normal
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-7_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-7_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-7_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-8_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_normal
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-8_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5.8_centos-8_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_centos-8_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-10_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_normal
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-10_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-10_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-10_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-9_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_normal
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-9_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5.8_debian-9_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_debian-9_malloctrim
          path: .


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_normal
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_normal
          path: .


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_jemalloc
          path: .


      - name: Fetch ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
        uses: actions/download-artifact@v1
        with:
          name: ruby-pkg_2.5.8_ubuntu-18.04_malloctrim
          path: .


      - name: Determine which Docker image to use for publishing
        uses: actions/download-artifact@v1
        with:
          name: docker-image-info-utility
          path: .
      - name: Load utility image info
        id: load_utility_image_info
        run: ./internal-scripts/ci-cd/load-docker-image-info.sh

      - name: Upload DEBs to repo
        run: ./internal-scripts/ci-cd/publish/publish-debs.sh *.deb
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt
          DRY_RUN: ${{ github.ref != 'refs/heads/master' }}
          IGNORE_EXISTING: true

      - name: Commit files published to APT repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-apt

      - name: Upload RPMs to repo
        run: ./internal-scripts/ci-cd/publish/publish-rpms.sh *.rpm
        env:
          UTILITY_IMAGE_NAME: ${{ steps.load_utility_image_info.outputs.image-name }}
          UTILITY_IMAGE_TAG: ${{ steps.load_utility_image_info.outputs.image-tag }}
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum
          DRY_RUN: ${{ github.ref != 'refs/heads/master' }}
          IGNORE_EXISTING: true

      - name: Commit files published to YUM repo
        run: ./internal-scripts/ci-cd/publish/commit-published-packages.sh
        env:
          BINTRAY_API_USERNAME: ${{ secrets.BINTRAY_API_USERNAME }}
          BINTRAY_API_KEY: ${{ secrets.BINTRAY_API_KEY }}
          REPO_NAME: fullstaq-ruby-yum


  ### Test packages against production repos ###

  # The Github Actions matrix is limited to producing 256 jobs. Given the
  # combinatorial explosion, it's very easy to reach that limit, so we
  # preprocess distribution information using ERB templating instead.


  test_packages_against_production_centos_7:
    name: Test Ruby packages against production repos [centos-7]
    needs: publish_packages_production
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        # The 'if' here is on the step level instead of job level.
        # Otherwise, the 'create_git_tag' job won't always be triggered.
        if: github.ref == 'refs/heads/master'
        env:
          DISTRIBUTION_NAME: "centos-7"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "centos:7"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org


  test_packages_against_production_centos_8:
    name: Test Ruby packages against production repos [centos-8]
    needs: publish_packages_production
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        # The 'if' here is on the step level instead of job level.
        # Otherwise, the 'create_git_tag' job won't always be triggered.
        if: github.ref == 'refs/heads/master'
        env:
          DISTRIBUTION_NAME: "centos-8"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "RPM"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "centos:8"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org


  test_packages_against_production_debian_10:
    name: Test Ruby packages against production repos [debian-10]
    needs: publish_packages_production
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        # The 'if' here is on the step level instead of job level.
        # Otherwise, the 'create_git_tag' job won't always be triggered.
        if: github.ref == 'refs/heads/master'
        env:
          DISTRIBUTION_NAME: "debian-10"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "debian:10"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org


  test_packages_against_production_debian_9:
    name: Test Ruby packages against production repos [debian-9]
    needs: publish_packages_production
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        # The 'if' here is on the step level instead of job level.
        # Otherwise, the 'create_git_tag' job won't always be triggered.
        if: github.ref == 'refs/heads/master'
        env:
          DISTRIBUTION_NAME: "debian-9"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "debian:9"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org


  test_packages_against_production_ubuntu_18_04:
    name: Test Ruby packages against production repos [ubuntu-18.04]
    needs: publish_packages_production
    runs-on: ubuntu-18.04
    strategy:
      max-parallel: 4 # avoid overloading Bintray
      matrix:
        ruby_package_version: 
        - minor_version: 2.7
          full_version: 2.7.1
          package_revision: 2
          id: 2.7
        - minor_version: 2.6
          full_version: 2.6.6
          package_revision: 6
          id: 2.6
        - minor_version: 2.5
          full_version: 2.5.8
          package_revision: 5
          id: 2.5
        - full_version: 2.7.1
          package_revision: 1
          id: 2.7.1
        - full_version: 2.6.6
          package_revision: 2
          id: 2.6.6
        - full_version: 2.5.8
          package_revision: 2
          id: 2.5.8
        variant: 
        - name: normal
          package_suffix: ''
        - name: jemalloc
          package_suffix: "-jemalloc"
        - name: malloctrim
          package_suffix: "-malloctrim"
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: ./internal-scripts/ci-cd/test-packages/run-tests.sh
        # The 'if' here is on the step level instead of job level.
        # Otherwise, the 'create_git_tag' job won't always be triggered.
        if: github.ref == 'refs/heads/master'
        env:
          DISTRIBUTION_NAME: "ubuntu-18.04"
          RUBY_PACKAGE_ID: ${{ matrix.ruby_package_version.id }}
          PACKAGE_FORMAT: "DEB"
          VARIANT_NAME: ${{ matrix.variant.name }}
          VARIANT_PACKAGE_SUFFIX: ${{ matrix.variant.package_suffix }}
          TEST_IMAGE_NAME: "ubuntu:18.04"
          APT_REPO_URL: https://apt.fullstaqruby.org
          YUM_REPO_URL: https://yum.fullstaqruby.org



  ### Create Git tag ###

  create_git_tag:
    name: Create Git tag
    needs:

      - test_packages_against_production_centos_7

      - test_packages_against_production_centos_8

      - test_packages_against_production_debian_10

      - test_packages_against_production_debian_9

      - test_packages_against_production_ubuntu_18_04

    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-ruby@v1
        with:
          ruby-version: '2.6'

      - name: Determine latest release version
        # Sets environment variable $LATEST_RELEASE_TAG
        run: ./internal-scripts/ci-cd/check-version-numbers-need-changing/determine-latest-release-tag.sh

      - name: Determine next epic version
        # Sets environment variable $NEXT_RELEASE_VERSION
        run: ./internal-scripts/ci-cd/create-git-tag/determine-next-epic-version.sh

      - name: Create Git tag
        run: git tag epic-${{ env.NEXT_RELEASE_VERSION }}

      - name: Push Git tag
        if: github.ref == 'refs/heads/master'
        run: git push origin epic-${{ env.NEXT_RELEASE_VERSION }}
